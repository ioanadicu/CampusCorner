<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='overlay.css') }}" />
  <link
      rel="stylesheet"
      href="{{ url_for('static', filename='todo_styles2.css') }}"
    />

  <!-- Room style -->
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    canvas {
      display: block;
    }

    /* Tooltip styling */
    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
  <!-- End Room Style -->
</head>

<body>
  <div id="overlay"></div>

  <!-- Container where the panel HTML will be injected -->
  <div id="panelContainer">
    <div id="todo-container">
      <div class="todo-content">
        <span id="close-todo">&times;</span>
        <!-- Close button -->
  
        <!-- üìå User Header (Shows Name & Points) -->
        <div id="user-header">
          <h2>Welcome, <span id="userFullName">{{ fullname }}</span></h2>
          <h3 id="user-points">üèÜ Points: <span id="userPoints">0</span></h3>
        </div>
  
        <div class="container">
          <!-- üìå Sidebar (Categories & Tags) -->
          <aside class="sidebar">
            <h2>Categories</h2>
            <div class="category" data-category="today">Today</div>
            <div class="category" data-category="upcoming">Upcoming</div>
            <div class="category" data-category="viewAll">View All</div>
  
            <!-- üìå Custom Tags Section -->
            <div class="custom-categories">
              <h3 id="tag-dropdown-header">Tags ‚ñº</h3>
              <div id="custom-category-list"></div>
            </div>
          </aside>
  
          <!-- üìå Main Content Area -->
          <main class="content" id="content"></main>
        </div>
      </div>
    </div>
  </div>

  <div id="scoreContainer">
    <div id="score">Score</div>
  </div>

  

  <!-- Room -->
  <!-- Tooltip container -->
  <div id="tooltip"></div>

  <!-- Load Three.js and Extensions -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/OutlinePass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/ShaderPass.js"></script>

  <!-- Load main.js -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script src="{{ url_for('static', filename='todo2.js') }}"></script>
  <script src="{{ url_for('static', filename='view_event.js') }}"></script>
  <script src="{{ url_for('static', filename='calendar_click.js') }}"></script>
  <!-- End Room -->
  <script>
    let listen = true;
    const scoreContainer = document.getElementById("scoreContainer");
    loadScore();

    const todoContainer = document.getElementById("todo-container");
  const closeTodoBtn = document.getElementById("close-todo");

 overlay.addEventListener("click", function () {
  if(todoContainer){
  todoContainer.style.display = "none";
  }
  overlay.style.display = "none";
});


  closeTodoBtn.addEventListener("click", function () {
    todoContainer.style.display = "none"; // ‚úÖ Hide with animation
    console.log("close todo");
    listen = true;
  });


    window.addEventListener("mousemove", (event) => {

      // Calculate mouse position
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      // Update raycaster
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(scene.children, true);

      const tooltip = document.getElementById("tooltip");
      if (intersects.length > 0) {
        let object = intersects[0].object;

        // Traverse up the hierarchy to find a meaningful parent name
        while (object.parent && object.parent.type !== "Scene") {
          if (object.name) break;
          object = object.parent;
        }

        // Display tooltip and apply highlighting
        if (["Monitor", "Door", "Calendar", "Todo", "Shelf", "Cat"].includes(object.name)) {
          listen = true;
          tooltip.style.display = "block";
          tooltip.style.left = event.clientX + 10 + "px"; // Offset from mouse
          tooltip.style.top = event.clientY + 10 + "px";
          tooltip.textContent = object.name;

          renderer.domElement.addEventListener("click", function () {
            //Monitor is clicked
            if (tooltip.textContent === 'Monitor' && listen) {

              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/auth/user/<username>/monitor");
            }

            if (tooltip.textContent === 'Calendar' && listen) {

              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/calendar");
            }

            if (tooltip.textContent === 'Todo' && listen) {
              const todoContainer = document.getElementById("todo-container");
              console.log(tooltip.textContent);
              listen = false;
              todoContainer.style.display="flex";
              //loadData();
              //showPopUp("/todo")
              //startToDo();
            }

            if (tooltip.textContent === 'Cat' && listen) {
              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/cat")
              }

              if (tooltip.textContent === 'Door' && listen) {
              console.log(tooltip.textContent);
              listen = false;
              window.location.href = '/navigation';
              }
          });
          setHighlightedObject(object);
        } else {
          listen = false;
          tooltip.style.display = "none";
          setHighlightedObject(null);
        }
      } else {
        listen = false;
        tooltip.style.display = "none";
        setHighlightedObject(null);
      }

    });



    function showPopUp(endpoint) {
      listen = false;
      if(endpoint === "/add_calendar"){
        endpoint = "/add_calendar?new_calendar=" + document.getElementById("cal_link").value;
      }
      if(endpoint === "back" || endpoint === "forward"){
        endpoint = "/change_month?direction=" + endpoint;
      }
      fetch(endpoint)
        .then((response) => response.text())
        .then((data) => {
          // Inject the panel content into the container
          //panelContainer.innerHTML = panelContainer.innerHTML+data;
          let injectedContent = document.getElementById("removable");
          if(!injectedContent){
            injectedContent = document.createElement('div');
            injectedContent.id = "removable";
            injectedContent.innerHTML = data;
            panelContainer.appendChild(injectedContent);
          }
          else{
            injectedContent.innerHTML = data;
          }
          
          
          // Show the panel and the overlay
          const popupPanel = document.getElementById("popupPanel");
          const closePanelButton =
            document.getElementById("closePanelButton");
          
          if(endpoint.includes("calendar") || endpoint.includes("month")){
            popupPanel.style.display = "flex";
          }
          else{
            if(popupPanel){
              popupPanel.style.display = "block";
            }
          }
          overlay.style.display = "block";
          if(endpoint === '/cat'){
            const catPanel = document.getElementById("catPanel");
            catPanel.style.display = "block";
            overlay.style.backgroundColor = "transparent";
          }
          // Close the panel when the close button is clicked
          if(closePanelButton){
          closePanelButton.addEventListener("click", function () {
            popupPanel.style.display = "none";
            overlay.style.display = "none";
            listen = true;
            panelContainer.removeChild(injectedContent);
          });
        }

          // Close the panel when the overlay is clicked
          overlay.addEventListener("click", function () {
            panelContainer.removeChild(injectedContent);
            if(popupPanel){
            popupPanel.style.display = "none";
            }
            overlay.style.display = "none";
            if(endpoint === '/cat'){
            const catPanel = document.getElementById("catPanel");
            catPanel.style.display = "none";
          }
            
          });
        })
        .catch((error) => {
          console.error("Error loading panel:", error);
        });
    }

    function loadScore(){
      fetch("/score")
      .then((response) => response.text())
      .then((data) => {
        console.log(data);
        scoreContainer.textContent = scoreContainer.textContent + data;

      });
    }

    function feedCat(food){
      fetch(`/feed_cat?food=${food}`)
      .then(response => response.text())
      .then((data) => {
        console.log(data);
        scoreContainer.textContent = "Score: " + data;
      })
    }
  </script>
</body>

</html>