<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='overlay.css') }}" />

  <!-- Room style -->
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    canvas {
      display: block;
    }

    /* Tooltip styling */
    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
  <!-- End Room Style -->
</head>

<body>
  <div id="overlay"></div>

  <!-- Container where the panel HTML will be injected -->
  <div id="panelContainer"></div>

  <!-- Room -->
  <!-- Tooltip container -->
  <div id="tooltip"></div>

  <!-- Load Three.js and Extensions -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/OutlinePass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/postprocessing/ShaderPass.js"></script>

  <!-- Load main.js -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <!-- End Room -->
  <script>
    let listen = true;

    window.addEventListener("mousemove", (event) => {

      // Calculate mouse position
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      // Update raycaster
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(scene.children, true);

      const tooltip = document.getElementById("tooltip");
      if (intersects.length > 0) {
        let object = intersects[0].object;

        // Traverse up the hierarchy to find a meaningful parent name
        while (object.parent && object.parent.type !== "Scene") {
          if (object.name) break;
          object = object.parent;
        }

        // Display tooltip and apply highlighting
        if (["Monitor", "Door", "Calendar", "Todo", "Shelf"].includes(object.name)) {
          listen = true;
          tooltip.style.display = "block";
          tooltip.style.left = event.clientX + 10 + "px"; // Offset from mouse
          tooltip.style.top = event.clientY + 10 + "px";
          tooltip.textContent = object.name;

          renderer.domElement.addEventListener("click", function () {
            //Monitor is clicked
            if (tooltip.textContent === 'Monitor' && listen) {

              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/auth/user/<username>/monitor");
            }

            if (tooltip.textContent === 'Calendar' && listen) {

              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/calendar");
            }

            if (tooltip.textContent === 'Todo' && listen) {

              console.log(tooltip.textContent);
              listen = false;
              showPopUp("/todo")
            }
          });
          setHighlightedObject(object);
        } else {
          listen = false;
          tooltip.style.display = "none";
          setHighlightedObject(null);
        }
      } else {
        listen = false;
        tooltip.style.display = "none";
        setHighlightedObject(null);
      }

    });



    function showPopUp(endpoint) {
      listen = false;
      fetch(endpoint)
        .then((response) => response.text())
        .then((data) => {
          // Inject the panel content into the container
          panelContainer.innerHTML = data;

          // Show the panel and the overlay
          const popupPanel = document.getElementById("popupPanel");
          const closePanelButton =
            document.getElementById("closePanelButton");

          popupPanel.style.display = "block";
          overlay.style.display = "block";

          // Close the panel when the close button is clicked
          closePanelButton.addEventListener("click", function () {
            popupPanel.style.display = "none";
            overlay.style.display = "none";
            listen = true;
          });

          // Close the panel when the overlay is clicked
          overlay.addEventListener("click", function () {
            popupPanel.style.display = "none";
            overlay.style.display = "none";
          });
        })
        .catch((error) => {
          console.error("Error loading panel:", error);
        });
    }
  </script>
</body>

</html>